<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>StudentÃ«t FSHN Analistike</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0f172a;font-family:'Sora',sans-serif;color:#f8fafc}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fi{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.fade{animation:fi .3s ease}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:#0f172a}::-webkit-scrollbar-thumb{background:#334155;border-radius:3px}
input,textarea,select,button{font-family:'Sora',sans-serif}textarea{resize:vertical}

/* Layout */
#app{display:flex;min-height:100vh}
#sidebar{width:250px;background:#1e293b;border-right:1px solid #334155;display:flex;flex-direction:column;flex-shrink:0;position:sticky;top:0;height:100vh}
#main{flex:1;overflow:auto;padding:24px 28px}

/* Sidebar */
.sb-brand{padding:18px 16px;border-bottom:1px solid #334155}
.sb-tag{font-size:10px;letter-spacing:3px;color:#3b82f6;font-weight:700;text-transform:uppercase}
.sb-title{font-size:16px;font-weight:800;color:#f8fafc;margin-top:4px}
.sb-sub{font-size:11px;color:#64748b;margin-top:2px}
.sb-nav{flex:1;padding:10px 8px;overflow-y:auto}
.nav-btn{width:100%;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;border:none;background:transparent;color:#94a3b8;font-size:13px;font-weight:400;cursor:pointer;margin-bottom:2px;text-align:left;transition:all .15s;border-left:3px solid transparent;position:relative}
.nav-btn:hover{background:rgba(59,130,246,.08);color:#cbd5e1}
.nav-btn.active{background:rgba(59,130,246,.15);color:#3b82f6;font-weight:600;border-left-color:#3b82f6}
.nbadge{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:#ef4444;color:#fff;font-size:10px;font-weight:700;border-radius:10px;padding:1px 6px}
.sb-user{padding:12px 14px;border-top:1px solid #334155}
.sb-uinfo{display:flex;align-items:center;gap:9px;margin-bottom:9px}
.avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#1e40af,#3b82f6);display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:700;flex-shrink:0;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.uname{font-size:13px;font-weight:600;color:#f8fafc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.urole{font-size:11px;color:#10b981}
.btn-logout{width:100%;padding:7px;border-radius:8px;border:1px solid #334155;background:transparent;color:#ef4444;font-size:12px;cursor:pointer}

/* Cards */
.card{background:#1e293b;border:1px solid #334155;border-radius:14px;padding:18px}
.card-title{font-size:14px;font-weight:700;color:#f8fafc;margin-bottom:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px}
.g2{display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-bottom:14px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.g2eq{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.mb14{margin-bottom:14px}
.stat-card{background:#1e293b;border:1px solid #334155;border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:5px}
.stat-val{font-size:26px;font-weight:800;color:#f8fafc}
.stat-lbl{font-size:12px;color:#64748b}
.stat-sub{font-size:10px;background:rgba(16,185,129,.1);color:#10b981;padding:2px 7px;border-radius:20px;font-weight:600;align-self:flex-start}

/* Badges */
.badge{font-size:11px;font-weight:600;padding:2px 8px;border-radius:20px;display:inline-block}
.badge-online{color:#10b981;background:rgba(16,185,129,.15)}
.badge-offline{color:#64748b;background:rgba(100,116,139,.15)}
.badge-active{color:#3b82f6;background:rgba(59,130,246,.15)}
.badge-published{color:#10b981;background:rgba(16,185,129,.15)}
.badge-draft{color:#64748b;background:rgba(100,116,139,.15)}
.badge-open{color:#10b981;background:rgba(16,185,129,.15)}
.badge-closed{color:#64748b;background:rgba(100,116,139,.15)}
.badge-grading{color:#f59e0b;background:rgba(245,158,11,.15)}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0}
.dot-online{background:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.2)}
.dot-offline{background:#64748b}

/* Buttons */
.btn{padding:9px 16px;border-radius:10px;border:none;cursor:pointer;font-size:13px;font-weight:600;transition:all .15s}
.btn-primary{background:linear-gradient(135deg,#1e40af,#3b82f6);color:#fff}
.btn-green{background:linear-gradient(135deg,#059669,#10b981);color:#fff}
.btn-ghost{background:transparent;border:1px solid #334155;color:#94a3b8}
.btn-ghost:hover{color:#f8fafc}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-danger{background:rgba(239,68,68,.15);color:#ef4444;border:none}
.btn-warn{background:rgba(245,158,11,.15);color:#f59e0b;border:none}
.btn-google{width:100%;padding:11px;background:#fff;border:none;border-radius:12px;color:#1e293b;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:9px;margin-bottom:12px}
.btn-google:hover{background:#f1f5f9}

/* Form */
.inp{width:100%;padding:10px 12px;background:#0f172a;border:1px solid #334155;border-radius:10px;color:#f8fafc;font-size:13px;outline:none;transition:border .15s}
.inp:focus{border-color:#3b82f6}
.lbl{color:#94a3b8;font-size:12px;font-weight:500;display:block;margin-bottom:4px}
.form-row{margin-bottom:12px}
select.inp option{background:#1e293b}

/* Table */
table{width:100%;border-collapse:collapse}
th{padding:8px 10px;text-align:left;font-size:11px;color:#64748b;font-weight:600;border-bottom:1px solid #334155;text-transform:uppercase}
td{padding:9px 10px;border-bottom:1px solid rgba(51,65,85,.4);font-size:13px}
tr:last-child td{border-bottom:none}
.prog-wrap{height:5px;background:#334155;border-radius:3px;overflow:hidden;width:65px}
.prog-bar{height:100%;border-radius:3px}

/* Login */
#login-page{min-height:100vh;background:linear-gradient(135deg,#0f172a 0%,#1e3a5f 50%,#0f172a 100%);display:flex;align-items:center;justify-content:center;padding:16px}
.login-box{background:rgba(30,41,59,.97);backdrop-filter:blur(20px);border-radius:22px;padding:36px 30px;width:100%;max-width:410px;border:1px solid rgba(59,130,246,.2);box-shadow:0 25px 60px rgba(0,0,0,.5)}
.role-tabs{display:flex;background:#0f172a;border-radius:12px;padding:4px;margin-bottom:18px}
.role-tab{flex:1;padding:9px;border-radius:10px;border:none;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.role-tab.active{background:#3b82f6;color:#fff}
.role-tab:not(.active){background:transparent;color:#64748b}
.btn-login{width:100%;padding:13px;background:linear-gradient(135deg,#1e40af,#3b82f6);border:none;border-radius:12px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:9px}
.btn-login:disabled{background:#334155;cursor:not-allowed}
.divider{display:flex;align-items:center;gap:10px;margin:12px 0;color:#475569;font-size:11px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:#334155}
.err-box{color:#ef4444;font-size:12px;margin-bottom:10px;background:rgba(239,68,68,.1);padding:9px 12px;border-radius:8px;border:1px solid rgba(239,68,68,.2)}
.ok-box{color:#10b981;font-size:12px;margin-bottom:10px;background:rgba(16,185,129,.1);padding:9px 12px;border-radius:8px;border:1px solid rgba(16,185,129,.2)}

/* Chat */
.chat-wrap{display:grid;grid-template-columns:200px 1fr;gap:14px;height:calc(100vh - 76px)}
.chat-side{background:#1e293b;border:1px solid #334155;border-radius:14px;display:flex;flex-direction:column;overflow:hidden}
.chat-main{background:#1e293b;border:1px solid #334155;border-radius:14px;display:flex;flex-direction:column;overflow:hidden}
.chat-hdr{padding:12px 14px;border-bottom:1px solid #334155;display:flex;align-items:center;gap:8px}
.chat-msgs{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:10px}
.chat-inp-row{padding:10px 14px;border-top:1px solid #334155;display:flex;gap:8px}
.msg-row{display:flex;gap:8px}
.msg-row.me{flex-direction:row-reverse}
.msg-av{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;flex-shrink:0;overflow:hidden}
.msg-av img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.msg-bubble{max-width:62%;background:#0f172a;border:1px solid #334155;border-radius:12px 12px 12px 4px;padding:8px 12px}
.msg-bubble.me{background:linear-gradient(135deg,#1e40af,#3b82f6);border:none;border-radius:12px 12px 4px 12px}
.msg-text{font-size:13px;line-height:1.5;color:#f8fafc}

/* Notifications */
.notif-item{background:#0f172a;border-radius:12px;padding:12px 13px;margin-bottom:8px;border-left:3px solid;display:flex;gap:10px;align-items:flex-start}
.notif-unread{background:rgba(59,130,246,.05)}

/* Misc */
.page-hdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px}
.page-title{font-size:22px;font-weight:800;color:#f8fafc}
.page-sub{font-size:12px;color:#64748b;margin-top:3px}
.row{display:flex;align-items:center;gap:8px}
.chip{font-size:11px;padding:3px 9px;border-radius:20px;font-weight:600}
.chip-green{color:#10b981;background:rgba(16,185,129,.1)}
.chip-blue{color:#3b82f6;background:rgba(59,130,246,.1)}
.chip-yellow{color:#f59e0b;background:rgba(245,158,11,.1)}
.empty-state{text-align:center;padding:40px 20px;color:#64748b}
.empty-icon{font-size:38px;margin-bottom:10px}
.grade-inp{width:65px;padding:6px 8px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#f8fafc;font-size:13px;font-weight:700;outline:none;text-align:center}
.grade-inp:focus{border-color:#10b981}
.alert-banner{border-radius:12px;padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:8px;font-size:13px}
.alert-warn{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);color:#f59e0b}
.alert-info{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);color:#3b82f6}
.alert-green{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:#10b981}
#spinner-page{min-height:100vh;background:#0f172a;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#64748b;font-size:14px}
.spinner{width:38px;height:38px;border:3px solid #334155;border-top:3px solid #3b82f6;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 12px}

/* â”€â”€ MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#mob-topbar{display:none}
#mob-nav{display:none}
@media(max-width:768px){
  #sidebar{display:none!important}
  #main{padding:12px 12px 78px 12px}
  #mob-topbar{display:flex;align-items:center;justify-content:space-between;background:#1e293b;border-bottom:1px solid #334155;padding:10px 14px;position:sticky;top:0;z-index:100}
  #mob-nav{display:flex;position:fixed;bottom:0;left:0;right:0;background:#1e293b;border-top:1px solid #334155;z-index:200;padding:4px 0 max(8px,env(safe-area-inset-bottom))}
  .mob-tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:5px 2px;border:none;background:transparent;cursor:pointer;position:relative}
  .mob-tab .mi{font-size:20px}
  .mob-tab .ml{font-size:9px;color:#64748b;font-family:'Sora',sans-serif}
  .mob-tab.active .ml{color:#3b82f6}
  .mob-tab .mb{position:absolute;top:2px;right:calc(50% - 16px);background:#ef4444;color:#fff;font-size:9px;font-weight:700;border-radius:9px;padding:1px 5px}
  .mob-tab.active::after{content:'';position:absolute;bottom:0;left:20%;right:20%;height:2px;background:#3b82f6;border-radius:2px}
  .g4{grid-template-columns:repeat(2,1fr)!important;gap:10px}
  .g2{grid-template-columns:1fr!important}
  .g3{grid-template-columns:repeat(2,1fr)!important;gap:10px}
  .g2eq{grid-template-columns:1fr!important}
  .chat-wrap{grid-template-columns:1fr!important;height:calc(100vh - 130px)}
  .chat-side{display:none!important}
  .card{border-radius:12px;padding:14px}
  .page-hdr{flex-direction:column;gap:10px}
  .page-title{font-size:19px}
  table thead{display:none}
  table,tbody,tr,td{display:block;width:100%}
  tr{background:#0f172a;border-radius:10px;margin-bottom:8px;padding:10px;border:1px solid #334155}
  td{border:none;padding:3px 0;font-size:12px}
  .login-box{padding:26px 20px}
}
@media(max-width:390px){
  .g4,.g3{grid-template-columns:1fr 1fr}
  #main{padding:10px 10px 76px}
}
</style>
</head>
<body>
<div id="spinner-page"><div class="spinner"></div>Duke u ngarkuar...</div>
<div id="login-page" style="display:none">
  <div class="login-box fade">
    <div style="text-align:center;margin-bottom:22px">
      <div style="font-size:10px;letter-spacing:4px;color:#3b82f6;font-weight:700;text-transform:uppercase;margin-bottom:6px">FSHN Â· UNIVERSITETI</div>
      <h1 style="font-size:22px;font-weight:800;color:#f8fafc;line-height:1.2">StudentÃ«t FSHN<br><span style="color:#3b82f6">Analistike</span></h1>
      <p style="color:#64748b;font-size:12px;margin-top:5px">PlatformÃ« Akademike 2024/2025</p>
    </div>
    <div class="role-tabs">
      <button class="role-tab active" id="tab-student" onclick="setRole('student')">ğŸ“ NxÃ«nÃ«s</button>
      <button class="role-tab" id="tab-teacher" onclick="setRole('teacher')">ğŸ‘¨â€ğŸ« MÃ«sues</button>
    </div>
    <button class="btn-google" onclick="googleSignIn()">
      <svg width="17" height="17" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
      Hyr me Google
    </button>
    <div class="divider">ose me email</div>
    <div id="reg-name-row" class="form-row" style="display:none"><label class="lbl">Emri i PlotÃ«</label><input class="inp" id="inp-name" placeholder="Emri Mbiemri"/></div>
    <div class="form-row"><label class="lbl">Email</label><input class="inp" id="inp-email" type="email" placeholder="emri@fshn.al"/></div>
    <div class="form-row"><label class="lbl">FjalÃ«kalimi</label><input class="inp" id="inp-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doAuth()"/></div>
    <div id="reg-code-row" class="form-row" style="display:none"><label class="lbl">Kodi i KlasÃ«s</label><input class="inp" id="inp-code" placeholder="p.sh. FSHN2024"/></div>
    <div id="auth-msg" style="display:none"></div>
    <button class="btn-login" id="btn-auth" onclick="doAuth()">Hyr nÃ« PlatformÃ« â†’</button>
    <p style="text-align:center;margin-top:14px;color:#64748b;font-size:12px">
      <span id="sw-txt">Nuk ke llogari?</span>
      <span onclick="toggleMode()" style="color:#3b82f6;cursor:pointer;font-weight:600;margin-left:4px" id="sw-lnk">Regjistrohu</span>
    </p>
  </div>
</div>
<div id="main-app" style="display:none">
  <div id="mob-topbar">
    <div style="font-size:14px;font-weight:800;color:#f8fafc">FSHN <span style="color:#3b82f6">Analistike</span></div>
    <div style="display:flex;align-items:center;gap:10px">
      <div class="avatar" id="mob-av" style="width:29px;height:29px;font-size:11px">U</div>
      <button onclick="doLogout()" style="background:transparent;border:none;color:#ef4444;font-size:20px;cursor:pointer">â¬…</button>
    </div>
  </div>
  <nav id="mob-nav"></nav>
  <div id="app">
    <div id="sidebar">
      <div class="sb-brand">
        <div class="sb-tag">FSHN Â· 2024/2025</div>
        <div class="sb-title">StudentÃ«t FSHN</div>
        <div class="sb-sub">PlatformÃ« Akademike</div>
      </div>
      <div class="sb-nav" id="sb-nav"></div>
      <div class="sb-user">
        <div class="sb-uinfo">
          <div class="avatar" id="sb-av">U</div>
          <div style="overflow:hidden"><div class="uname" id="sb-name">â€”</div><div class="urole" id="sb-role">â—</div></div>
        </div>
        <button class="btn-logout" onclick="doLogout()">â¬… Dil</button>
      </div>
    </div>
    <div id="main"></div>
  </div>
</div>

<script>
// Dynamically load scripts in sequence, then start app
function loadScript(src) {
  return new Promise(function(resolve, reject) {
    var s = document.createElement('script');
    s.src = src;
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}
loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js')
  .then(function(){ return loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js'); })
  .then(function(){ return loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js'); })
  .then(function(){ return loadScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js'); })
  .then(function(){ startApp(); })
  .catch(function(e){ document.getElementById('spinner-page').innerHTML='<p style="color:#ef4444;padding:20px">Gabim duke ngarkuar. Kontrolloni lidhjen me internetin.</p>'; });
</script>
<script>
function startApp() {
// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var app = firebase.initializeApp({
  apiKey:"AIzaSyChKAsK5d6qJJ1OOHMYuulcBYX7RCC4iis",
  authDomain:"studentet-fshn.firebaseapp.com",
  projectId:"studentet-fshn",
  storageBucket:"studentet-fshn.firebasestorage.app",
  messagingSenderId:"1033057546262",
  appId:"1:1033057546262:web:34ae43eed24a6042abc537"
});
var auth = firebase.auth();
var db = firebase.firestore();
var gProv = new firebase.auth.GoogleAuthProvider();

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var CU=null, PAGE='dashboard', isReg=false, selRole='student';
var students=[], tests=[], assignments=[], notifications=[], sessions=[];
var charts={}, testTimer=null, activeTest=null, testAnswers={};
var chatUnsub=null, subs=[], submittedA={}, activeSessId=null;
var gradeStudId=null, gradeTestId=null, gradeAssId=null;

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setRole(r){
  selRole=r;
  document.getElementById('tab-student').classList.toggle('active',r==='student');
  document.getElementById('tab-teacher').classList.toggle('active',r==='teacher');
  document.getElementById('reg-code-row').style.display=(isReg&&r==='student')?'':'none';
}
function toggleMode(){
  isReg=!isReg;
  document.getElementById('reg-name-row').style.display=isReg?'':'none';
  document.getElementById('reg-code-row').style.display=(isReg&&selRole==='student')?'':'none';
  document.getElementById('sw-txt').textContent=isReg?'Ke llogari?':'Nuk ke llogari?';
  document.getElementById('sw-lnk').textContent=isReg?'Hyr':'Regjistrohu';
  document.getElementById('btn-auth').textContent=isReg?'Regjistrohu â†’':'Hyr â†’';
  hideMsg();
}
function showMsg(t,ok){var e=document.getElementById('auth-msg');e.className=ok?'ok-box':'err-box';e.textContent=t;e.style.display='';}
function hideMsg(){document.getElementById('auth-msg').style.display='none';}

async function googleSignIn(){
  try{
    var res=await auth.signInWithPopup(gProv);
    var u=res.user;
    var snap=await db.collection('users').doc(u.uid).get();
    if(!snap.exists){
      var av=(u.displayName||'U').split(' ').map(function(n){return n[0];}).join('').toUpperCase().slice(0,2);
      await db.collection('users').doc(u.uid).set({uid:u.uid,name:u.displayName||'PÃ«rdorues',email:u.email,role:selRole,classCode:'',avatar:av,photoURL:u.photoURL||'',status:'online',attendance:0,avgGrade:0,tests:0,assignments:0,emailVerified:true,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    }else{
      await db.collection('users').doc(u.uid).update({status:'online',photoURL:u.photoURL||''});
    }
  }catch(e){showMsg(e.message,false);}
}

async function doAuth(){
  var email=document.getElementById('inp-email').value.trim();
  var pass=document.getElementById('inp-pass').value;
  var name=document.getElementById('inp-name').value.trim();
  var code=document.getElementById('inp-code').value.trim();
  hideMsg();
  if(!email||!pass){showMsg('PlotÃ«so tÃ« gjitha fushat.',false);return;}
  if(isReg&&!name){showMsg('Shkruaj emrin tÃ«nd.',false);return;}
  var btn=document.getElementById('btn-auth');
  btn.disabled=true;btn.textContent='Duke u lidhur...';
  try{
    if(isReg){
      var c=await auth.createUserWithEmailAndPassword(email,pass);
      await c.user.updateProfile({displayName:name});
      await c.user.sendEmailVerification();
      var av2=name.split(' ').map(function(n){return n[0];}).join('').toUpperCase().slice(0,2);
      await db.collection('users').doc(c.user.uid).set({uid:c.user.uid,name:name,email:email,role:selRole,classCode:code,avatar:av2,photoURL:'',status:'online',attendance:0,avgGrade:0,tests:0,assignments:0,emailVerified:false,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      showMsg('âœ… Llogaria u krijua! Kontrolloni emailin tuaj.',true);
      await auth.signOut();
      btn.disabled=false;btn.textContent='Regjistrohu â†’';return;
    }else{
      await auth.signInWithEmailAndPassword(email,pass);
    }
  }catch(e){
    var m={'auth/user-not-found':'Email-i nuk ekziston.','auth/wrong-password':'FjalÃ«kalim i gabuar.','auth/email-already-in-use':'Email tashmÃ« i regjistruar.','auth/weak-password':'FjalÃ«kalimi duhet 6+ karaktere.','auth/invalid-credential':'Email ose fjalÃ«kalim i gabuar.'};
    showMsg(m[e.code]||e.message,false);
    btn.disabled=false;btn.textContent=isReg?'Regjistrohu â†’':'Hyr â†’';
  }
}

async function doLogout(){
  if(CU)await db.collection('users').doc(CU.uid).update({status:'offline'}).catch(function(){});
  subs.forEach(function(u){if(u)u();});subs=[];
  if(chatUnsub){chatUnsub();chatUnsub=null;}
  await auth.signOut();
}

// â”€â”€ AUTH LISTENER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
auth.onAuthStateChanged(async function(fbU){
  document.getElementById('spinner-page').style.display='none';
  if(fbU){
    var snap=await db.collection('users').doc(fbU.uid).get();
    if(snap.exists){
      CU=Object.assign({},snap.data(),{uid:fbU.uid});
      await db.collection('users').doc(fbU.uid).update({status:'online',emailVerified:fbU.emailVerified}).catch(function(){});
      CU.emailVerified=fbU.emailVerified;
      document.getElementById('login-page').style.display='none';
      document.getElementById('main-app').style.display='';
      initApp();
    }else{
      document.getElementById('login-page').style.display='';
    }
  }else{
    CU=null;
    document.getElementById('login-page').style.display='';
    document.getElementById('main-app').style.display='none';
  }
});

// â”€â”€ APP INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setAv(el,u){if(u&&u.photoURL)el.innerHTML='<img src="'+u.photoURL+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>';else el.textContent=(u&&u.avatar)||'U';}

function initApp(){
  setAv(document.getElementById('sb-av'),CU);
  setAv(document.getElementById('mob-av'),CU);
  document.getElementById('sb-name').textContent=CU.name;
  document.getElementById('sb-role').textContent='â— '+(CU.role==='teacher'?'MÃ«sues':'NxÃ«nÃ«s');
  buildNav();
  subs.push(db.collection('users').where('role','==','student').onSnapshot(function(s){students=s.docs.map(function(d){return Object.assign({uid:d.id},d.data());});if(['dashboard','students','analytics'].includes(PAGE))render();}));
  subs.push(db.collection('tests').orderBy('createdAt','desc').onSnapshot(function(s){tests=s.docs.map(function(d){return Object.assign({id:d.id},d.data());});if(PAGE==='tests')render();},function(){}));
  subs.push(db.collection('assignments').orderBy('createdAt','desc').onSnapshot(function(s){assignments=s.docs.map(function(d){return Object.assign({id:d.id},d.data());});if(PAGE==='assignments')render();},function(){}));
  subs.push(db.collection('sessions').orderBy('createdAt','desc').onSnapshot(function(s){sessions=s.docs.map(function(d){return Object.assign({id:d.id},d.data());});buildNav();if(PAGE==='sessions'||PAGE==='chat')render();},function(){}));
  subs.push(db.collection('notifications').where('toId','==',CU.uid).orderBy('createdAt','desc').onSnapshot(function(s){notifications=s.docs.map(function(d){return Object.assign({id:d.id},d.data());});buildNav();if(PAGE==='notifications')render();},function(){}));
  render();
}

function buildNav(){
  var unread=notifications.filter(function(n){return!n.read;}).length;
  var openS=sessions.find(function(s){return s.status==='open';});
  var navT=[['dashboard','ğŸ“Š','Dashboard'],['students','ğŸ‘¥','NxÃ«nÃ«s'],['tests','ğŸ“','Testime'],['assignments','ğŸ“š','Detyra'],['sessions','ğŸ’¬','Chat'],['analytics','ğŸ“ˆ','AnalitikÃ«']];
  var navS=[['dashboard','ğŸ ','Home'],['tests','ğŸ“','Teste'],['assignments','ğŸ“š','Detyra'],['chat','ğŸ’¬','Chat'+(openS?' ğŸŸ¢':'')],['notifications','ğŸ””','Njoftimet'],['profile','ğŸ‘¤','Profili']];
  var nav=CU.role==='teacher'?navT:navS;

  // Desktop sidebar
  document.getElementById('sb-nav').innerHTML=nav.map(function(x){
    var id=x[0],ico=x[1],lbl=x[2];
    var b=(id==='notifications'&&unread)?'<span class="nbadge">'+unread+'</span>':'';
    return '<button class="nav-btn'+(id===PAGE?' active':'')+'" onclick="goTo(\''+id+'\')"><span style="font-size:15px">'+ico+'</span>'+lbl+b+'</button>';
  }).join('');

  // Mobile bottom nav (5 items)
  var mob=nav.slice(0,5);
  var mn=document.getElementById('mob-nav');
  if(mn)mn.innerHTML=mob.map(function(x){
    var id=x[0],ico=x[1],lbl=x[2].replace(' ğŸŸ¢','');
    var b=(id==='notifications'&&unread)?'<span class="mb">'+unread+'</span>':'';
    return '<button class="mob-tab'+(id===PAGE?' active':'')+'" onclick="goTo(\''+id+'\')">'+b+'<span class="mi">'+ico+'</span><span class="ml">'+lbl+'</span></button>';
  }).join('');
}

function goTo(p){
  PAGE=p;
  Object.values(charts).forEach(function(c){c.destroy();});charts={};
  if(chatUnsub&&p!=='chat'){chatUnsub();chatUnsub=null;}
  buildNav();render();
  window.scrollTo(0,0);
}

function render(){
  var m=document.getElementById('main');if(!m)return;
  switch(PAGE){
    case 'dashboard':m.innerHTML=CU.role==='teacher'?teacherDash():studentDash();break;
    case 'students':m.innerHTML=studentsPage();break;
    case 'grade-student':m.innerHTML=gradeStudentPage();setTimeout(function(){loadGrades();},80);break;
    case 'tests':m.innerHTML=testsPage();break;
    case 'test-create':m.innerHTML=testCreatePage();break;
    case 'test-grade':m.innerHTML=testGradePage();setTimeout(function(){loadTestSubs();},80);break;
    case 'test-take':m.innerHTML=testTakePage();startTimer();break;
    case 'assignments':m.innerHTML=assignPage();break;
    case 'assign-create':m.innerHTML=assignCreatePage();break;
    case 'assign-grade':m.innerHTML=assignGradePage();setTimeout(function(){loadAssignSubs();},80);break;
    case 'sessions':m.innerHTML=sessionsPage();break;
    case 'chat':m.innerHTML=chatPage();setTimeout(function(){initChat();},80);break;
    case 'notifications':m.innerHTML=notifsPage();setTimeout(function(){markRead();},80);break;
    case 'analytics':m.innerHTML=analyticsPage();break;
    case 'profile':m.innerHTML=profilePage();break;
  }
  setTimeout(function(){initCharts();},100);
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BD(s){var L={online:'Online',offline:'Offline',active:'Aktiv',published:'Publikuar',draft:'Draft',open:'Hapur',closed:'Mbyllur',grading:'VlerÃ«sohet'};return'<span class="badge badge-'+s+'">'+(L[s]||s)+'</span>';}
function DOT(s){return'<span class="dot dot-'+(s||'offline')+'"></span>';}
function AV(u,sz){sz=sz||32;var st='width:'+sz+'px;height:'+sz+'px;font-size:'+Math.round(sz*.35)+'px';if(u&&u.photoURL)return'<div class="avatar" style="'+st+'"><img src="'+u.photoURL+'"/></div>';return'<div class="avatar" style="'+st+'">'+(u&&u.avatar||'U')+'</div>';}
function FTS(ts){if(!ts)return'â€”';var d=ts.toDate?ts.toDate():new Date(ts);return d.toLocaleTimeString('sq-AL',{hour:'2-digit',minute:'2-digit'});}
function FTD(ts){if(!ts)return'â€”';var d=ts.toDate?ts.toDate():new Date(ts);return d.toLocaleDateString('sq-AL',{day:'2-digit',month:'short',year:'numeric'});}
function PB(v,mx){mx=mx||100;var p=Math.min((v/mx)*100,100);var c=p>79?'#10b981':p>59?'#f59e0b':'#ef4444';return'<div class="prog-wrap"><div class="prog-bar" style="width:'+p+'%;background:'+c+'"></div></div>';}
function SC(ico,lbl,val,sub){return'<div class="stat-card"><div style="display:flex;justify-content:space-between"><span style="font-size:22px">'+ico+'</span><span class="stat-sub">'+sub+'</span></div><div class="stat-val">'+val+'</div><div class="stat-lbl">'+lbl+'</div></div>';}

async function pushNotif(toId,type,title,desc){
  await db.collection('notifications').add({toId:toId,type:type,title:title,desc:desc,read:false,fromName:CU.name,createdAt:firebase.firestore.FieldValue.serverTimestamp()}).catch(function(){});
}

// â”€â”€ DASHBOARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function teacherDash(){
  var online=students.filter(function(s){return s.status==='online';}).length;
  return'<div class="fade"><div class="page-hdr"><div><div class="page-title">Dashboard</div><div class="page-sub">'+new Date().toLocaleDateString('sq-AL',{weekday:'long',day:'2-digit',month:'long'})+'</div></div></div>'
    +'<div class="g4">'+SC('ğŸ‘¥','NxÃ«nÃ«s',students.length,'Gjithsej')+SC('ğŸŸ¢','Online',online,'Tani')+SC('ğŸ“','Testime',tests.length,'Total')+SC('ğŸ“š','Detyra',assignments.filter(function(a){return a.status==='published';}).length,'Aktive')+'</div>'
    +'<div class="g2"><div class="card"><div class="card-title">Progresi i KlasÃ«s</div><canvas id="cp" height="175"></canvas></div>'
    +'<div class="card"><div class="card-title">PjesÃ«marrja</div><canvas id="cpie" height="145"></canvas><div style="margin-top:9px">'
    +[['#10b981','Prezente','82%'],['#ef4444','Mungon','12%'],['#f59e0b','Justifikim','6%']].map(function(x){return'<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px"><span style="width:8px;height:8px;border-radius:2px;background:'+x[0]+';flex-shrink:0"></span><span style="color:#94a3b8">'+x[1]+'</span><span style="margin-left:auto;color:#f8fafc;font-weight:600">'+x[2]+'</span></div>';}).join('')
    +'</div></div></div>'
    +'<div class="card" style="margin-top:0"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><div class="card-title" style="margin:0">Lista e KlasÃ«s</div><span class="chip chip-green">'+online+' online</span></div>'+studentsTable()+'</div></div>';
}

function studentsTable(){
  if(!students.length)return'<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><p>AsnjÃ« nxÃ«nÃ«s i regjistruar.</p></div>';
  return'<div style="overflow-x:auto"><table><thead><tr><th>#</th><th>NxÃ«nÃ«si</th><th>Statusi</th><th>PjesÃ«marrja</th><th>Nota</th><th></th></tr></thead><tbody>'
    +students.map(function(s,i){return'<tr><td style="color:#64748b">'+(i+1)+'</td><td><div class="row">'+AV(s,30)+'<div><div style="font-weight:500">'+s.name+'</div><div style="font-size:11px;color:#64748b">'+s.email+'</div></div></div></td><td><div class="row">'+DOT(s.status||'offline')+BD(s.status||'offline')+'</div></td><td><div class="row">'+PB(s.attendance||0,100)+'<span style="font-size:12px;font-weight:600">'+(s.attendance||0)+'%</span></div></td><td><span style="font-weight:800;font-size:14px;color:'+((s.avgGrade||0)>=5?'#10b981':'#ef4444')+'">'+(s.avgGrade||'â€”')+'</span></td><td><button class="btn btn-sm btn-primary" onclick="openGradeS(\''+s.uid+'\')">VlerÃ«so</button></td></tr>';}).join('')
    +'</tbody></table></div>';
}

function studentDash(){
  var open=sessions.find(function(s){return s.status==='open';});
  var unread=notifications.filter(function(n){return!n.read;}).length;
  return'<div class="fade"><div class="page-hdr"><div><div class="page-title">MirÃ« se erdhe, '+CU.name.split(' ')[0]+'! ğŸ‘‹</div><div class="page-sub">'+new Date().toLocaleDateString('sq-AL',{weekday:'long',day:'2-digit',month:'long',year:'numeric'})+'</div></div>'
    +(open?'<button id="btn-att" class="btn btn-green" onclick="confirmAtt()">ğŸŸ¢ Konfirmo PjesÃ«marrjen</button>':'<div style="padding:9px 14px;background:rgba(100,116,139,.1);border-radius:10px;font-size:12px;color:#64748b">ğŸ”’ MÃ«simi nuk ka filluar</div>')
    +'</div>'
    +(!CU.emailVerified?'<div class="alert-banner alert-warn">âš ï¸ Email-i juaj nuk Ã«shtÃ« konfirmuar. Kontrolloni kutinÃ« postare.</div>':'')
    +(unread>0?'<div class="alert-banner alert-info">ğŸ”” Keni <strong>'+unread+'</strong> njoftim tÃ« palexuar â€” <span onclick="goTo(\'notifications\')" style="cursor:pointer;text-decoration:underline">Shiko</span></div>':'')
    +'<div class="g4">'+SC('ğŸ“Š','Nota Mes.',CU.avgGrade||'â€”','VlerÃ«sim')+SC('âœ…','PjesÃ«marrja',(CU.attendance||0)+'%','Total')+SC('ğŸ“','Testime',CU.tests||0,'Kryer')+SC('ğŸ“š','Detyra',CU.assignments||0,'DorÃ«zuar')+'</div>'
    +'<div class="g2"><div class="card"><div class="card-title">Progresi Im</div><canvas id="cp" height="175"></canvas></div>'
    +'<div class="card"><div class="card-title">ğŸ”” Njoftimet e Fundit</div>'
    +notifications.slice(0,5).map(function(n){
      var col=n.type==='grade'?'#10b981':n.type==='test'?'#3b82f6':n.type==='chat'?'#a855f7':'#f59e0b';
      var ico=n.type==='grade'?'ğŸ“Š':n.type==='test'?'ğŸ“':n.type==='chat'?'ğŸ’¬':'ğŸ“š';
      return'<div style="display:flex;gap:9px;padding:9px 0;border-bottom:1px solid #334155"><span style="font-size:17px">'+ico+'</span><div style="flex:1"><div style="font-size:12px;font-weight:600">'+n.title+'</div><div style="font-size:11px;color:#64748b">'+n.desc+'</div></div>'+(!n.read?'<span class="chip chip-blue" style="font-size:9px;flex-shrink:0">E re</span>':'')+'</div>';
    }).join('')
    +(notifications.length===0?'<div class="empty-state" style="padding:20px"><p>AsnjÃ« njoftim.</p></div>':'')
    +'</div></div></div>';
}

async function confirmAtt(){
  var open=sessions.find(function(s){return s.status==='open';});
  if(!open){alert('Nuk ka mÃ«sim aktiv.');return;}
  var ex=await db.collection('attendance').where('studentId','==',CU.uid).where('sessionId','==',open.id).get();
  if(!ex.empty){alert('Keni konfirmuar tashmÃ«.');return;}
  await db.collection('attendance').add({studentId:CU.uid,studentName:CU.name,sessionId:open.id,date:new Date().toISOString().split('T')[0],createdAt:firebase.firestore.FieldValue.serverTimestamp()});
  var nA=Math.min((CU.attendance||0)+1,100);
  await db.collection('users').doc(CU.uid).update({attendance:nA});
  CU.attendance=nA;
  var b=document.getElementById('btn-att');
  if(b){b.textContent='âœ… Konfirmuar';b.disabled=true;b.style.background='rgba(16,185,129,.15)';b.style.color='#10b981';b.style.border='2px solid #10b981';}
}

// â”€â”€ STUDENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function studentsPage(){
  return'<div class="fade"><div class="page-hdr"><div><div class="page-title">ğŸ‘¥ NxÃ«nÃ«sit</div></div><span class="chip chip-green">'+students.length+' gjithsej</span></div>'
    +(!students.length?'<div class="card"><div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><p>AsnjÃ« nxÃ«nÃ«s.</p></div></div>'
    :'<div class="g3">'+students.map(function(s){
      return'<div class="card"><div class="row" style="margin-bottom:11px"><div style="position:relative">'+AV(s,40)+'<div style="position:absolute;bottom:0;right:0;width:10px;height:10px;border-radius:50%;background:'+(s.status==='online'?'#10b981':'#64748b')+';border:2px solid #1e293b"></div></div>'
        +'<div><div style="font-weight:600;font-size:13px">'+s.name+'</div><div style="font-size:11px;color:#64748b">'+s.email+'</div>'+(s.classCode?'<div style="font-size:10px;color:#3b82f6">ğŸ”‘ '+s.classCode+'</div>':'')+'</div></div>'
        +'<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px">'
        +[['âœ…',(s.attendance||0)+'%','Pjes.'],['ğŸ“',s.tests||0,'Teste'],['ğŸ“š',s.assignments||0,'Detyra']].map(function(x){return'<div style="background:#0f172a;border-radius:7px;padding:7px;text-align:center"><div>'+x[0]+'</div><div style="font-size:12px;font-weight:700">'+x[1]+'</div><div style="font-size:10px;color:#64748b">'+x[2]+'</div></div>';}).join('')
        +'</div><div style="display:flex;gap:6px"><div style="flex:1;padding:5px;border-radius:7px;background:'+(s.status==='online'?'rgba(16,185,129,.1)':'rgba(100,116,139,.1)')+';color:'+(s.status==='online'?'#10b981':'#64748b')+';font-size:11px;text-align:center;font-weight:600">'+(s.status==='online'?'ğŸŸ¢ Online':'âš« Offline')+'</div>'
        +'<button class="btn btn-sm btn-primary" onclick="openGradeS(\''+s.uid+'\')">VlerÃ«so</button>'
        +'<button class="btn btn-sm btn-danger" onclick="delS(\''+s.uid+'\')">ğŸ—‘</button></div></div>';
    }).join('')+'</div>')+'</div>';
}
function openGradeS(uid){gradeStudId=uid;PAGE='grade-student';Object.values(charts).forEach(function(c){c.destroy();});charts={};buildNav();render();}
async function delS(uid){if(!confirm('Fshi?'))return;await db.collection('users').doc(uid).delete();}

function gradeStudentPage(){
  var s=students.find(function(x){return x.uid===gradeStudId;});
  if(!s)return'<div class="card"><p style="color:#64748b">Nuk u gjet.</p></div>';
  return'<div class="fade"><div class="row" style="gap:12px;margin-bottom:18px"><button class="btn btn-ghost btn-sm" onclick="goTo(\'students\')">â† Kthehu</button><div class="page-title">VlerÃ«so: '+s.name+'</div></div>'
    +'<div class="g2eq"><div class="card"><div class="card-title">â• Shto VlerÃ«sim</div>'
    +'<div class="form-row"><label class="lbl">Lloji</label><select class="inp" id="gtype"><option value="test">ğŸ“ Test</option><option value="assignment">ğŸ“š DetyrÃ«</option><option value="oral">ğŸ—£ Gojor</option><option value="project">ğŸ¯ Projekt</option><option value="participation">âœ‹ PjesÃ«marrje</option></select></div>'
    +'<div class="form-row"><label class="lbl">Nota (1â€“10)</label><input class="inp" id="gval" type="number" min="1" max="10" placeholder="p.sh. 8"/></div>'
    +'<div class="form-row"><label class="lbl">Koment (opsional)</label><textarea class="inp" id="gcmt" rows="3" placeholder="Koment..."></textarea></div>'
    +'<button class="btn btn-primary" style="width:100%;padding:11px" onclick="saveGrade(\''+s.uid+'\',\''+s.name+'\')">ğŸ’¾ Ruaj VlerÃ«simin</button></div>'
    +'<div class="card"><div class="card-title">ğŸ“Š Historia</div><div id="gh">Duke ngarkuar...</div></div></div></div>';
}
async function loadGrades(){
  var el=document.getElementById('gh');if(!el)return;
  var snap=await db.collection('grades').where('studentId','==',gradeStudId).orderBy('createdAt','desc').get().catch(function(){return null;});
  if(!snap||snap.empty){el.innerHTML='<div class="empty-state" style="padding:20px"><p>AsnjÃ« vlerÃ«sim.</p></div>';return;}
  var TL={test:'Test',assignment:'DetyrÃ«',oral:'Gojor',project:'Projekt',participation:'PjesÃ«marrje'};
  el.innerHTML=snap.docs.map(function(d){var g=d.data();return'<div style="background:#0f172a;border-radius:10px;padding:11px;margin-bottom:8px;display:flex;justify-content:space-between;border:1px solid #334155"><div><div style="font-size:13px;font-weight:600">'+(TL[g.type]||g.type)+'</div>'+(g.comment?'<div style="font-size:11px;color:#64748b;margin-top:2px">'+g.comment+'</div>':'')+'<div style="font-size:10px;color:#475569;margin-top:3px">'+FTD(g.createdAt)+'</div></div><div style="font-size:22px;font-weight:800;color:'+(g.grade>=5?'#10b981':'#ef4444')+'">'+g.grade+'</div></div>';}).join('');
}
async function saveGrade(sid,sname){
  var type=document.getElementById('gtype').value;
  var gv=parseFloat(document.getElementById('gval').value);
  var cmt=document.getElementById('gcmt').value.trim();
  if(!gv||gv<1||gv>10){alert('Nota 1â€“10.');return;}
  var TL={test:'Test',assignment:'DetyrÃ«',oral:'VlerÃ«sim Gojor',project:'Projekt',participation:'PjesÃ«marrje'};
  await db.collection('grades').add({studentId:sid,studentName:sname,type:type,grade:gv,comment:cmt,teacherId:CU.uid,teacherName:CU.name,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
  var snap=await db.collection('grades').where('studentId','==',sid).get();
  var avg=Math.round(snap.docs.map(function(d){return d.data().grade;}).reduce(function(a,b){return a+b;},0)/snap.docs.length*10)/10;
  await db.collection('users').doc(sid).update({avgGrade:avg});
  await pushNotif(sid,'grade','NotÃ« e re: '+gv+'/10',(TL[type]||type)+(cmt?' â€” '+cmt:'')+' (nga '+CU.name+')');
  alert('âœ… Nota '+gv+' u ruajt!');
  document.getElementById('gval').value='';document.getElementById('gcmt').value='';
  loadGrades();
}

// â”€â”€ TESTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function testsPage(){
  return'<div class="fade"><div class="page-hdr"><div><div class="page-title">ğŸ“ Testime</div></div>'+(CU.role==='teacher'?'<button class="btn btn-primary" onclick="goTo(\'test-create\')">+ Krijo</button>':'')+'</div>'
    +(!tests.length?'<div class="card"><div class="empty-state"><div class="empty-icon">ğŸ“</div><p>'+(CU.role==='teacher'?'Krijo testin e parÃ«!':'AsnjÃ« test aktiv.')+'</p></div></div>'
    :tests.map(function(t){
      return'<div class="card mb14"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div style="flex:1"><div class="row" style="margin-bottom:6px;gap:7px;flex-wrap:wrap"><span style="font-weight:700;font-size:15px">'+t.title+'</span>'+BD(t.status)+'</div>'
        +'<div style="display:flex;gap:12px;flex-wrap:wrap">'+[['ğŸ“…',t.date||'â€”'],['â±',t.duration+' min'],['ğŸ’¯',t.totalPoints+' pikÃ«'],['â“',(t.questions||[]).length+' pyetje']].map(function(x){return'<span style="color:#64748b;font-size:12px">'+x[0]+' '+x[1]+'</span>';}).join('')+'</div></div>'
        +'<div style="display:flex;gap:7px;flex-shrink:0">'
        +(CU.role==='teacher'?(t.status==='draft'?'<button class="btn btn-sm btn-green" onclick="activateT(\''+t.id+'\')">â–¶ Aktivizo</button>':t.status==='active'?'<button class="btn btn-sm btn-warn" onclick="startGradeT(\''+t.id+'\')">ğŸ“Š VlerÃ«so</button>':''):(t.status==='active'?'<button class="btn btn-sm btn-green" onclick="prepTest(\''+t.id+'\')">â–¶ Fillo</button>':''))
        +'</div></div></div>';
    }).join(''))+'</div>';
}
async function activateT(id){
  await db.collection('tests').doc(id).update({status:'active'});
  var t=tests.find(function(x){return x.id===id;});
  var ss=await db.collection('users').where('role','==','student').get();
  for(var i=0;i<ss.docs.length;i++)await pushNotif(ss.docs[i].id,'test','Test i ri aktiv! ğŸ“','"'+(t?t.title:'Test')+'" â€” '+(t?t.duration:'')+'min');
}
function startGradeT(id){gradeTestId=id;PAGE='test-grade';Object.values(charts).forEach(function(c){c.destroy();});charts={};buildNav();render();}
function prepTest(id){var t=tests.find(function(x){return x.id===id;});if(!t)return;activeTest=t;testAnswers={};PAGE='test-take';Object.values(charts).forEach(function(c){c.destroy();});charts={};buildNav();render();}

function testGradePage(){
  var t=tests.find(function(x){return x.id===gradeTestId;});
  return'<div class="fade"><div class="row" style="gap:12px;margin-bottom:18px"><button class="btn btn-ghost btn-sm" onclick="goTo(\'tests\')">â† Kthehu</button><div class="page-title">VlerÃ«so: '+(t?t.title:'Test')+'</div></div><div class="card" id="tsubs">Duke ngarkuar...</div></div>';
}
async function loadTestSubs(){
  var el=document.getElementById('tsubs');if(!el)return;
  var t=tests.find(function(x){return x.id===gradeTestId;});if(!t)return;
  var snap=await db.collection('testAttempts').where('testId','==',gradeTestId).get().catch(function(){return null;});
  if(!snap||snap.empty){el.innerHTML='<div class="card-title">DorÃ«zimet (0)</div><div class="empty-state"><p>AsnjÃ« nxÃ«nÃ«s nuk dorÃ«zoi.</p></div>';return;}
  el.innerHTML='<div class="card-title">DorÃ«zimet ('+snap.docs.length+')</div>'
    +snap.docs.map(function(d){var a=d.data();return'<div style="background:#0f172a;border-radius:12px;padding:13px;margin-bottom:9px;border:1px solid #334155"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:9px"><div><div style="font-weight:600">'+a.studentName+'</div><div style="font-size:11px;color:#64748b">'+FTS(a.submittedAt)+'</div></div><div class="row"><input class="grade-inp" type="number" min="0" max="'+t.totalPoints+'" placeholder="PikÃ«" id="tg-'+d.id+'"/><button class="btn btn-sm btn-green" onclick="saveTG(\''+d.id+'\',\''+a.studentId+'\',\''+a.studentName+'\','+t.totalPoints+',\''+t.title.replace(/'/g,"\\'")+'\'  )">Ruaj</button></div></div>'
    +(t.questions||[]).map(function(q,qi){return'<div style="font-size:12px;background:#1e293b;border-radius:8px;padding:8px;margin-bottom:5px"><span style="color:#64748b">'+(qi+1)+'. '+q.text+'</span><br><span style="color:#3b82f6">â†’ '+(a.answers&&a.answers[q.id]!==undefined?(q.type==='open'?a.answers[q.id]:q.type==='tf'?(a.answers[q.id]===0?'E VÃ«rtetÃ«':'E Gabuar'):(q.options&&q.options[a.answers[q.id]]||'â€”')):'Pa pÃ«rgjigje')+'</span></div>';}).join('')+'</div>';}).join('');
}
async function saveTG(attId,sid,sname,maxPts,ttitle){
  var inp=document.getElementById('tg-'+attId);
  var pts=parseFloat(inp?inp.value:0);
  if(isNaN(pts)||pts<0||pts>maxPts){alert('PikÃ«t 0â€“'+maxPts+'.');return;}
  var grade=Math.round((pts/maxPts)*10*10)/10;
  await db.collection('testAttempts').doc(attId).update({grade:grade,points:pts,graded:true});
  await db.collection('grades').add({studentId:sid,studentName:sname,type:'test',grade:grade,comment:'Test: "'+ttitle+'" ('+pts+'/'+maxPts+' pikÃ«)',teacherId:CU.uid,teacherName:CU.name,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
  var snap=await db.collection('grades').where('studentId','==',sid).get();
  var avg=Math.round(snap.docs.map(function(d){return d.data().grade;}).reduce(function(a,b){return a+b;},0)/snap.docs.length*10)/10;
  await db.collection('users').doc(sid).update({avgGrade:avg,tests:firebase.firestore.FieldValue.increment(1)});
  await pushNotif(sid,'test','Rezultati: '+grade+'/10','"'+ttitle+'" â€” '+pts+'/'+maxPts+' pikÃ«');
  alert('âœ… Nota '+grade+' u ruajt!');
}

var NTD={title:'',description:'',duration:45,totalPoints:100},NTQ=[];
function testCreatePage(){
  return'<div class="fade"><div class="row" style="gap:12px;margin-bottom:18px"><button class="btn btn-ghost btn-sm" onclick="goTo(\'tests\')">â† Kthehu</button><div class="page-title">Krijo Test</div></div>'
    +'<div class="g2eq mb14"><div class="card"><div class="card-title">Informacioni</div>'
    +'<div class="form-row"><label class="lbl">Titulli</label><input class="inp" id="nt-t" value="'+NTD.title+'" oninput="NTD.title=this.value"/></div>'
    +'<div class="form-row"><label class="lbl">PÃ«rshkrimi</label><input class="inp" id="nt-d" value="'+NTD.description+'" oninput="NTD.description=this.value"/></div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div class="form-row"><label class="lbl">KohÃ«zgjatja(min)</label><input class="inp" type="number" value="'+NTD.duration+'" oninput="NTD.duration=+this.value"/></div>'
    +'<div class="form-row"><label class="lbl">PikÃ«t Totale</label><input class="inp" type="number" value="'+NTD.totalPoints+'" oninput="NTD.totalPoints=+this.value"/></div></div></div>'
    +'<div class="card"><div class="card-title">Publiko</div><div style="font-size:13px;color:#94a3b8;margin-bottom:12px">Pyetje: <strong id="qc" style="color:#f8fafc">'+NTQ.length+'</strong></div>'
    +'<div style="display:flex;flex-direction:column;gap:8px"><button class="btn btn-ghost" onclick="saveTest(\'draft\')">ğŸ’¾ Draft</button><button class="btn btn-primary" style="padding:12px" onclick="saveTest(\'active\')">ğŸ“¤ ShpÃ«rnda</button></div></div></div>'
    +'<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:13px"><div class="card-title" style="margin:0">Pyetjet (<span id="qc2">'+NTQ.length+'</span>)</div><button class="btn btn-primary btn-sm" onclick="addQ()">+ Shto</button></div>'
    +'<div id="qlist">'+renderQL()+'</div></div></div>';
}
function renderQL(){
  if(!NTQ.length)return'<div class="empty-state"><div class="empty-icon">ğŸ“</div><p>Klikoni "+ Shto"</p></div>';
  return NTQ.map(function(q,i){
    return'<div style="background:#0f172a;border-radius:12px;padding:13px;margin-bottom:10px;border:1px solid #334155"><div style="display:flex;gap:9px;margin-bottom:9px">'
      +'<div style="background:#3b82f6;color:#fff;border-radius:7px;width:23px;height:23px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;flex-shrink:0">'+(i+1)+'</div>'
      +'<div style="flex:1"><input class="inp" value="'+(q.text||'')+'" placeholder="Pyetja..." oninput="NTQ['+i+'].text=this.value" style="margin-bottom:8px"/>'
      +'<div style="display:flex;gap:7px;flex-wrap:wrap">'
      +'<select class="inp" style="width:auto" onchange="NTQ['+i+'].type=this.value;refreshQL()"><option value="mcq"'+(q.type==='mcq'?' selected':'')+'>Me Alternativa</option><option value="open"'+(q.type==='open'?' selected':'')+'>Hapur</option><option value="tf"'+(q.type==='tf'?' selected':'')+'>V/G</option></select>'
      +'<input class="inp" type="number" value="'+q.points+'" style="width:62px" oninput="NTQ['+i+'].points=+this.value"/>'
      +'<button class="btn btn-sm btn-danger" onclick="NTQ.splice('+i+',1);refreshQL()">ğŸ—‘</button></div></div></div>'
      +(q.type==='mcq'?'<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-left:32px">'+(q.options||['','','','']).map(function(o,oi){return'<div class="row"><span style="color:#3b82f6;font-weight:700;width:14px;font-size:11px">'+String.fromCharCode(65+oi)+'.</span><input class="inp" value="'+o+'" placeholder="Opsioni" oninput="NTQ['+i+'].options['+oi+']=this.value" style="border-color:'+(q.correct===oi?'#10b981':'')+'"/><button onclick="NTQ['+i+'].correct='+oi+';refreshQL()" style="padding:3px 6px;border-radius:5px;border:none;background:'+(q.correct===oi?'#10b981':'#334155')+';color:#fff;cursor:pointer;font-size:10px">âœ“</button></div>';}).join('')+'</div>'
      :q.type==='tf'?'<div style="display:flex;gap:8px;margin-left:32px">'+['E VÃ«rtetÃ«','E Gabuar'].map(function(o,oi){return'<button onclick="NTQ['+i+'].correct='+oi+';refreshQL()" style="padding:7px 15px;border-radius:8px;border:2px solid '+(q.correct===oi?'#10b981':'#334155')+';background:'+(q.correct===oi?'rgba(16,185,129,.15)':'transparent')+';color:'+(q.correct===oi?'#10b981':'#94a3b8')+';cursor:pointer;font-size:12px;font-weight:600">'+o+'</button>';}).join('')+'</div>':'')
      +'</div>';
  }).join('');
}
function addQ(){NTQ.push({id:Date.now(),text:'',type:'mcq',points:10,options:['','','',''],correct:0});refreshQL();}
function refreshQL(){var el=document.getElementById('qlist');if(el)el.innerHTML=renderQL();var c=document.getElementById('qc');var c2=document.getElementById('qc2');if(c)c.textContent=NTQ.length;if(c2)c2.textContent=NTQ.length;}
async function saveTest(status){
  if(!NTD.title){alert('Shkruaj titullin!');return;}
  await db.collection('tests').add(Object.assign({},NTD,{status:status,questions:NTQ,createdBy:CU.uid,createdByName:CU.name,date:new Date().toISOString().split('T')[0],participants:0,avgScore:0,createdAt:firebase.firestore.FieldValue.serverTimestamp()}));
  if(status==='active'){var ss=await db.collection('users').where('role','==','student').get();for(var i=0;i<ss.docs.length;i++)await pushNotif(ss.docs[i].id,'test','Test i ri aktiv! ğŸ“','"'+NTD.title+'" â€” '+NTD.duration+'min');}
  NTD={title:'',description:'',duration:45,totalPoints:100};NTQ=[];goTo('tests');
}

function testTakePage(){
  var qs=activeTest.questions||[];
  return'<div class="fade"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px"><div><div class="page-title">'+activeTest.title+'</div><div class="page-sub">'+(activeTest.description||'')+'</div></div>'
    +'<div style="background:rgba(59,130,246,.1);border:2px solid #3b82f6;border-radius:13px;padding:10px 18px;text-align:center"><div style="font-size:10px;font-weight:600;color:#64748b;letter-spacing:1px">KOHA</div><div id="timer-val" style="font-size:26px;font-weight:800;font-variant-numeric:tabular-nums">'+fmtS(activeTest.duration*60)+'</div></div></div>'
    +qs.map(function(q,qi){
      return'<div style="background:#1e293b;border:1px solid #334155;border-radius:13px;padding:15px;margin-bottom:11px"><div style="display:flex;justify-content:space-between;margin-bottom:11px"><div class="row"><div style="background:#3b82f6;color:#fff;border-radius:7px;width:23px;height:23px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;flex-shrink:0">'+(qi+1)+'</div><p style="font-size:14px;font-weight:500">'+q.text+'</p></div><span style="color:#3b82f6;font-weight:600;font-size:12px;flex-shrink:0">'+q.points+' pikÃ«</span></div>'
        +(q.type==='mcq'?'<div style="display:grid;grid-template-columns:1fr 1fr;gap:7px">'+(q.options||[]).map(function(o,oi){return'<button id="opt-'+q.id+'-'+oi+'" onclick="selOpt(\''+q.id+'\','+oi+')" style="padding:9px 12px;border-radius:9px;border:2px solid #334155;background:#0f172a;color:#94a3b8;cursor:pointer;text-align:left;font-size:13px"><strong style="color:#3b82f6">'+String.fromCharCode(65+oi)+'.</strong> '+o+'</button>';}).join('')+'</div>'
        :q.type==='tf'?'<div style="display:flex;gap:8px">'+['E VÃ«rtetÃ«','E Gabuar'].map(function(o,oi){return'<button id="opt-'+q.id+'-'+oi+'" onclick="selOpt(\''+q.id+'\','+oi+')" style="padding:9px 20px;border-radius:9px;border:2px solid #334155;background:#0f172a;color:#94a3b8;cursor:pointer;font-size:13px;font-weight:600">'+o+'</button>';}).join('')+'</div>'
        :'<textarea class="inp" rows="3" placeholder="Shkruaj pÃ«rgjigjen..." oninput="testAnswers[\''+q.id+'\']=this.value" style="margin-top:4px"></textarea>')
        +'</div>';
    }).join('')
    +'<div style="text-align:center;margin-top:16px"><button class="btn btn-green" style="padding:13px 40px;font-size:14px" onclick="submitTest()">âœ… DÃ«rgo</button></div></div>';
}
function startTimer(){
  if(testTimer)clearInterval(testTimer);
  var s=activeTest.duration*60;
  testTimer=setInterval(function(){s--;var e=document.getElementById('timer-val');if(e){e.textContent=fmtS(s);if(s<300)e.style.color='#ef4444';}if(s<=0){clearInterval(testTimer);submitTest();}},1000);
}
function fmtS(s){return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');}
function selOpt(qId,idx){
  testAnswers[qId]=idx;
  document.querySelectorAll('[id^="opt-'+qId+'-"]').forEach(function(b){b.style.borderColor='#334155';b.style.background='#0f172a';b.style.color='#94a3b8';});
  var e=document.getElementById('opt-'+qId+'-'+idx);
  if(e){e.style.borderColor='#3b82f6';e.style.background='rgba(59,130,246,.15)';e.style.color='#3b82f6';}
}
async function submitTest(){
  if(testTimer)clearInterval(testTimer);
  try{await db.collection('testAttempts').add({testId:activeTest.id,studentId:CU.uid,studentName:CU.name,answers:testAnswers,submittedAt:firebase.firestore.FieldValue.serverTimestamp(),status:'submitted'});}catch(e){}
  Object.values(charts).forEach(function(c){c.destroy();});charts={};
  document.getElementById('main').innerHTML='<div class="fade"><div class="card" style="text-align:center;padding:50px 40px"><div style="font-size:52px;margin-bottom:12px">ğŸ‰</div><h2 style="font-size:22px;font-weight:800;margin-bottom:8px">DorÃ«zuar me sukses!</h2><p style="color:#64748b;margin-bottom:18px">Profesori do tÃ« shpallÃ« rezultatin.</p><button class="btn btn-primary" onclick="goTo(\'tests\')">â† Kthehu</button></div></div>';
}

// â”€â”€ ASSIGNMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var NAD={title:'',description:'',deadline:'',maxPoints:50};
function assignPage(){
  return'<div class="fade"><div class="page-hdr"><div><div class="page-title">ğŸ“š Detyrat</div></div>'+(CU.role==='teacher'?'<button class="btn btn-primary" onclick="goTo(\'assign-create\')">+ Krijo</button>':'')+'</div>'
    +(!assignments.length?'<div class="card"><div class="empty-state"><div class="empty-icon">ğŸ“š</div><p>'+(CU.role==='teacher'?'Krijo detyrÃ«n e parÃ«!':'AsnjÃ« detyrÃ«.')+'</p></div></div>'
    :assignments.map(function(a){
      return'<div class="card mb14"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div class="row" style="margin-bottom:5px;gap:7px"><span style="font-weight:700;font-size:15px">'+a.title+'</span>'+BD(a.status)+'</div>'
        +'<div style="display:flex;gap:12px;flex-wrap:wrap"><span style="color:#64748b;font-size:12px">ğŸ“… '+(a.deadline||'â€”')+'</span><span style="color:#64748b;font-size:12px">ğŸ’¯ '+a.maxPoints+' pikÃ«</span>'+(CU.role==='teacher'?'<span style="color:#64748b;font-size:12px">ğŸ“¤ '+(a.submitted||0)+' dorÃ«zuan</span>':'')+'</div>'
        +(a.description?'<p style="color:#64748b;font-size:12px;margin-top:5px">'+a.description+'</p>':'')+'</div>'
        +'<div style="display:flex;gap:7px;flex-shrink:0">'
        +(CU.role==='teacher'&&a.status==='published'?'<button class="btn btn-sm btn-warn" onclick="openGradeAs(\''+a.id+'\')">ğŸ“Š VlerÃ«so</button>':CU.role==='student'?(submittedA[a.id]?'<span style="color:#10b981;font-size:12px;font-weight:600">âœ… DorÃ«zuar</span>':(a.status==='published'?'<button class="btn btn-sm btn-primary" onclick="submitA(\''+a.id+'\')">DÃ«rgo</button>':'')):'')
        +'</div></div>'
        +(CU.role==='student'&&!submittedA[a.id]&&a.status==='published'?'<textarea class="inp" rows="3" id="atext-'+a.id+'" placeholder="Shkruaj pÃ«rgjigjen tÃ«nde..." style="margin-top:8px"></textarea>':'')
        +'</div>';
    }).join(''))+'</div>';
}
function openGradeAs(id){gradeAssId=id;PAGE='assign-grade';Object.values(charts).forEach(function(c){c.destroy();});charts={};buildNav();render();}

function assignGradePage(){
  var a=assignments.find(function(x){return x.id===gradeAssId;});
  return'<div class="fade"><div class="row" style="gap:12px;margin-bottom:18px"><button class="btn btn-ghost btn-sm" onclick="goTo(\'assignments\')">â† Kthehu</button><div class="page-title">VlerÃ«so: '+(a?a.title:'DetyrÃ«')+'</div></div><div class="card" id="asubs">Duke ngarkuar...</div></div>';
}
async function loadAssignSubs(){
  var el=document.getElementById('asubs');if(!el)return;
  var a=assignments.find(function(x){return x.id===gradeAssId;});
  var snap=await db.collection('assignmentSubmissions').where('assignmentId','==',gradeAssId).get().catch(function(){return null;});
  if(!snap||snap.empty){el.innerHTML='<div class="card-title">DorÃ«zimet (0)</div><div class="empty-state"><p>AsnjÃ« nxÃ«nÃ«s nuk dorÃ«zoi.</p></div>';return;}
  el.innerHTML='<div class="card-title">DorÃ«zimet ('+snap.docs.length+')</div>'
    +snap.docs.map(function(d){var s=d.data();return'<div style="background:#0f172a;border-radius:12px;padding:13px;margin-bottom:9px;border:1px solid #334155"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div><div style="font-weight:600">'+s.studentName+'</div><div style="font-size:11px;color:#64748b">'+FTD(s.submittedAt)+'</div></div><div class="row"><input class="grade-inp" type="number" min="0" max="'+(a?a.maxPoints:100)+'" placeholder="PikÃ«" id="ag-'+d.id+'"/><button class="btn btn-sm btn-green" onclick="saveAG(\''+d.id+'\',\''+s.studentId+'\',\''+s.studentName+'\','+(a?a.maxPoints:100)+',\''+((a?a.title:'DetyrÃ«').replace(/'/g,"\\'"))+'\')">Ruaj</button></div></div><p style="font-size:12px;color:#94a3b8;background:#1e293b;border-radius:8px;padding:8px">'+(s.text||'Pa tekst')+'</p></div>';}).join('');
}
async function saveAG(subId,sid,sname,maxPts,atitle){
  var inp=document.getElementById('ag-'+subId);
  var pts=parseFloat(inp?inp.value:0);
  if(isNaN(pts)||pts<0||pts>maxPts){alert('PikÃ«t 0â€“'+maxPts+'.');return;}
  var grade=Math.round((pts/maxPts)*10*10)/10;
  await db.collection('assignmentSubmissions').doc(subId).update({grade:grade,points:pts,graded:true});
  await db.collection('grades').add({studentId:sid,studentName:sname,type:'assignment',grade:grade,comment:'DetyrÃ«: "'+atitle+'" ('+pts+'/'+maxPts+' pikÃ«)',teacherId:CU.uid,teacherName:CU.name,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
  var snap=await db.collection('grades').where('studentId','==',sid).get();
  var avg=Math.round(snap.docs.map(function(d){return d.data().grade;}).reduce(function(a,b){return a+b;},0)/snap.docs.length*10)/10;
  await db.collection('users').doc(sid).update({avgGrade:avg,assignments:firebase.firestore.FieldValue.increment(1)});
  await pushNotif(sid,'assignment','Nota e detyrÃ«s: '+grade+'/10','"'+atitle+'" â€” '+pts+'/'+maxPts+' pikÃ«');
  alert('âœ… Nota '+grade+' u ruajt!');
}
async function submitA(id){
  var el=document.getElementById('atext-'+id);
  await db.collection('assignmentSubmissions').add({assignmentId:id,studentId:CU.uid,studentName:CU.name,text:el?el.value:'',submittedAt:firebase.firestore.FieldValue.serverTimestamp(),status:'submitted'});
  await db.collection('assignments').doc(id).update({submitted:firebase.firestore.FieldValue.increment(1)});
  submittedA[id]=true;alert('âœ… DorÃ«zuar!');render();
}
function assignCreatePage(){
  return'<div class="fade"><div class="row" style="gap:12px;margin-bottom:18px"><button class="btn btn-ghost btn-sm" onclick="goTo(\'assignments\')">â† Kthehu</button><div class="page-title">Krijo DetyrÃ«</div></div>'
    +'<div class="g2eq"><div class="card"><div class="card-title">Detajet</div>'
    +'<div class="form-row"><label class="lbl">Titulli</label><input class="inp" placeholder="Titulli" oninput="NAD.title=this.value"/></div>'
    +'<div class="form-row"><label class="lbl">Afati</label><input class="inp" type="datetime-local" oninput="NAD.deadline=this.value"/></div>'
    +'<div class="form-row"><label class="lbl">PikÃ«t Maksimale</label><input class="inp" type="number" value="50" oninput="NAD.maxPoints=+this.value"/></div>'
    +'<div class="form-row"><label class="lbl">Instruksionet</label><textarea class="inp" rows="5" placeholder="Instruksionet..." oninput="NAD.description=this.value"></textarea></div></div>'
    +'<div class="card"><div class="card-title">Publiko</div><div style="display:flex;flex-direction:column;gap:8px"><button class="btn btn-ghost" onclick="saveA(\'draft\')">ğŸ’¾ Draft</button><button class="btn btn-primary" style="padding:12px" onclick="saveA(\'published\')">ğŸ“¤ Publiko</button></div></div></div></div>';
}
async function saveA(status){
  if(!NAD.title){alert('Shkruaj titullin!');return;}
  await db.collection('assignments').add(Object.assign({},NAD,{status:status,createdBy:CU.uid,createdByName:CU.name,submitted:0,total:0,createdAt:firebase.firestore.FieldValue.serverTimestamp()}));
  if(status==='published'){var ss=await db.collection('users').where('role','==','student').get();for(var i=0;i<ss.docs.length;i++)await pushNotif(ss.docs[i].id,'assignment','DetyrÃ« e re! ğŸ“š','"'+NAD.title+'" â€” Afati: '+(NAD.deadline||'â€”'));}
  NAD={title:'',description:'',deadline:'',maxPoints:50};goTo('assignments');
}

// â”€â”€ SESSIONS (teacher) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sessionsPage(){
  var open=sessions.find(function(s){return s.status==='open';});
  return'<div class="fade"><div class="page-hdr"><div><div class="page-title">ğŸ’¬ Seancat Chat</div><div class="page-sub">Ã‡do mÃ«sim = chat i ri</div></div>'
    +(!open?'<button class="btn btn-green" onclick="openSess()">â–¶ Hap MÃ«simin</button>':'<button class="btn btn-danger" onclick="closeSess(\''+open.id+'\')">â¹ Mbyll</button>')+'</div>'
    +(open?'<div class="alert-banner alert-green">ğŸŸ¢ <strong>'+(open.title||'MÃ«sim')+'</strong> aktive â€” <span onclick="goTo(\'chat\')" style="cursor:pointer;text-decoration:underline">Hyr nÃ« Chat â†’</span></div>':'')
    +'<div class="card"><div class="card-title">Historia e Seancave</div>'
    +(!sessions.length?'<div class="empty-state"><p>AsnjÃ« seancÃ«.</p></div>'
    :sessions.map(function(s){return'<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#0f172a;border-radius:10px;margin-bottom:7px;border:1px solid #334155"><div><div style="font-weight:600;font-size:13px">'+(s.title||'MÃ«sim')+' '+BD(s.status)+'</div><div style="font-size:11px;color:#64748b;margin-top:2px">'+(s.msgCount||0)+' mesazhe Â· '+FTD(s.createdAt)+'</div></div><button class="btn btn-sm btn-ghost" onclick="activeSessId=\''+s.id+'\';goTo(\'chat\')">Chat</button></div>';}).join(''))
    +'</div></div>';
}
async function openSess(){
  var title=prompt('Titulli i mÃ«simit:','MÃ«sim '+(sessions.length+1));
  var open=sessions.find(function(s){return s.status==='open';});
  if(open)await db.collection('sessions').doc(open.id).update({status:'closed'});
  var ref=await db.collection('sessions').add({title:title||'MÃ«sim '+(sessions.length+1),status:'open',teacherId:CU.uid,teacherName:CU.name,msgCount:0,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
  activeSessId=ref.id;
  var ss=await db.collection('users').where('role','==','student').get();
  for(var i=0;i<ss.docs.length;i++)await pushNotif(ss.docs[i].id,'chat','MÃ«simi ka filluar! ğŸ’¬','Prof. '+CU.name+': "'+(title||'MÃ«sim')+'" â€” Hyni nÃ« Chat');
  goTo('chat');
}
async function closeSess(id){if(!confirm('Mbyll seancÃ«n?'))return;await db.collection('sessions').doc(id).update({status:'closed'});activeSessId=null;render();}

// â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function chatPage(){
  var open=sessions.find(function(s){return s.status==='open';});
  var target=activeSessId?sessions.find(function(s){return s.id===activeSessId;}):open;
  if(!target)return'<div class="fade"><div class="card"><div class="empty-state"><div class="empty-icon">ğŸ’¬</div><p>'+(CU.role==='teacher'?'Hapni njÃ« seancÃ« tÃ« re.':'MÃ«simi nuk ka filluar. Prisni profesorin.')+'</p>'+(CU.role==='teacher'?'<button class="btn btn-green" style="margin-top:14px" onclick="goTo(\'sessions\')">â–¶ Hap</button>':'')+'</div></div></div>';
  return'<div class="chat-wrap fade"><div class="chat-side"><div class="chat-hdr"><div style="font-weight:700;font-size:13px">Seancat</div></div><div style="padding:9px;overflow-y:auto;flex:1">'
    +sessions.slice(0,8).map(function(s){var cur=activeSessId===s.id||(s.status==='open'&&!activeSessId);return'<div onclick="activeSessId=\''+s.id+'\';if(chatUnsub){chatUnsub();chatUnsub=null;}goTo(\'chat\')" style="padding:8px 10px;border-radius:9px;background:'+(cur?'rgba(59,130,246,.15)':'transparent')+';cursor:pointer;margin-bottom:3px;border-left:3px solid '+(cur?'#3b82f6':'transparent')+'"><div style="font-size:12px;font-weight:600">'+(s.title||'MÃ«sim')+'</div><div style="font-size:10px;color:'+(s.status==='open'?'#10b981':'#64748b')+'">'+(s.status==='open'?'ğŸŸ¢ Aktiv':'Mbyllur')+'</div></div>';}).join('')
    +'</div></div><div class="chat-main"><div class="chat-hdr"><div style="width:9px;height:9px;border-radius:50%;background:'+(target.status==='open'?'#10b981':'#64748b')+'"></div><span style="font-weight:700;font-size:14px">'+(target.title||'MÃ«sim')+'</span><span style="font-size:11px;color:'+(target.status==='open'?'#10b981':'#64748b')+';margin-left:4px">'+(target.status==='open'?'Aktiv':'Mbyllur')+'</span></div>'
    +'<div class="chat-msgs" id="chat-msgs"><div style="text-align:center;color:#64748b;padding:20px">Duke ngarkuar...</div></div>'
    +(target.status==='open'?'<div class="chat-inp-row"><input class="inp" id="chat-inp" placeholder="Shkruaj..." onkeydown="if(event.key===\'Enter\')sendMsg(\''+target.id+'\')" style="flex:1"/><button class="btn btn-primary" style="padding:10px 14px;font-size:17px" onclick="sendMsg(\''+target.id+'\')">â¤</button></div>':'<div style="padding:10px;text-align:center;color:#64748b;font-size:12px;border-top:1px solid #334155">Seanca Ã«shtÃ« mbyllur.</div>')
    +'</div></div>';
}
function initChat(){
  var open=sessions.find(function(s){return s.status==='open';});
  var tid=activeSessId||(open?open.id:null);
  if(!tid)return;
  if(chatUnsub)chatUnsub();
  chatUnsub=db.collection('messages').where('sessionId','==',tid).orderBy('createdAt','asc').onSnapshot(function(snap){
    var msgs=snap.docs.map(function(d){return Object.assign({id:d.id},d.data());});
    var el=document.getElementById('chat-msgs');if(!el)return;
    el.innerHTML=msgs.map(function(msg){
      var me=msg.uid===CU.uid;
      var bgAv=msg.role==='teacher'?'linear-gradient(135deg,#7c3aed,#a855f7)':'linear-gradient(135deg,#1e40af,#3b82f6)';
      var avEl=msg.photoURL?'<div class="msg-av"><img src="'+msg.photoURL+'"/></div>':'<div class="msg-av" style="background:'+bgAv+'">'+(msg.avatar||'U')+'</div>';
      return'<div class="msg-row'+(me?' me':'')+'">'+avEl+'<div><div style="display:flex;gap:6px;align-items:baseline;flex-direction:'+(me?'row-reverse':'row')+'"><span style="font-size:11px;font-weight:600;color:'+(msg.role==='teacher'?'#a855f7':'#94a3b8')+'">'+msg.sender+'</span><span style="font-size:10px;color:#475569">'+FTS(msg.createdAt)+'</span></div><div class="msg-bubble'+(me?' me':'')+'"><p class="msg-text">'+msg.text+'</p></div></div></div>';
    }).join('')||'<div style="text-align:center;color:#64748b;padding:30px;font-size:13px">AsnjÃ« mesazh. Filloni bisedÃ«n! ğŸ’¬</div>';
    el.scrollTop=el.scrollHeight;
    db.collection('sessions').doc(tid).update({msgCount:msgs.length}).catch(function(){});
  });
}
async function sendMsg(sessId){
  var inp=document.getElementById('chat-inp');
  if(!inp||!inp.value.trim())return;
  var txt=inp.value.trim();inp.value='';
  await db.collection('messages').add({sessionId:sessId,sender:CU.name,role:CU.role,text:txt,avatar:CU.avatar||'U',photoURL:CU.photoURL||'',uid:CU.uid,createdAt:firebase.firestore.FieldValue.serverTimestamp()}).catch(function(){});
}

// â”€â”€ NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function notifsPage(){
  var unread=notifications.filter(function(n){return!n.read;}).length;
  return'<div class="fade"><div class="page-hdr"><div><div class="page-title">ğŸ”” Njoftimet</div><div class="page-sub">'+unread+' tÃ« palexuara</div></div></div>'
    +(!notifications.length?'<div class="card"><div class="empty-state"><div class="empty-icon">ğŸ””</div><p>AsnjÃ« njoftim.</p></div></div>'
    :notifications.map(function(n){
      var col=n.type==='grade'?'#10b981':n.type==='test'?'#3b82f6':n.type==='chat'?'#a855f7':'#f59e0b';
      var ico=n.type==='grade'?'ğŸ“Š':n.type==='test'?'ğŸ“':n.type==='chat'?'ğŸ’¬':'ğŸ“š';
      return'<div class="notif-item '+(n.read?'':'notif-unread')+'" style="border-left-color:'+col+'"><span style="font-size:19px">'+ico+'</span><div style="flex:1"><div style="font-size:13px;font-weight:600">'+n.title+'</div><div style="font-size:12px;color:#64748b;margin-top:2px">'+(n.desc||'')+'</div><div style="font-size:10px;color:#475569;margin-top:3px">'+FTD(n.createdAt)+' Â· nga '+(n.fromName||'sistem')+'</div></div>'+(!n.read?'<span class="chip chip-blue" style="font-size:9px;flex-shrink:0;align-self:flex-start">E re</span>':'')+'</div>';
    }).join(''))+'</div>';
}
async function markRead(){
  var batch=db.batch();
  notifications.filter(function(n){return!n.read;}).forEach(function(n){batch.update(db.collection('notifications').doc(n.id),{read:true});});
  await batch.commit().catch(function(){});
}

// â”€â”€ ANALYTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function analyticsPage(){
  return'<div class="fade"><div class="page-hdr"><div class="page-title">ğŸ“ˆ AnalitikÃ«</div></div>'
    +'<div class="g2eq mb14"><div class="card"><div class="card-title">ğŸ† Renditja</div>'
    +(!students.length?'<div class="empty-state"><p>AsnjÃ« nxÃ«nÃ«s.</p></div>'
    :[].concat(students).sort(function(a,b){return(b.avgGrade||0)-(a.avgGrade||0);}).map(function(s,i){
      return'<div style="display:flex;align-items:center;gap:9px;padding:9px 11px;background:'+(i<3?'rgba(59,130,246,.08)':'#0f172a')+';border-radius:9px;border:'+(i<3?'1px solid rgba(59,130,246,.2)':'1px solid #334155')+';margin-bottom:6px">'
        +'<div style="font-size:14px;width:22px;text-align:center">'+(['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]||((i+1)+'.'))+AV(s,27)+'</div>'
        +'<span style="font-size:13px;flex:1">'+s.name+'</span>'+DOT(s.status||'offline')
        +'<span style="font-weight:800;font-size:14px;color:'+((s.avgGrade||0)>=5?'#10b981':'#ef4444')+'">'+(s.avgGrade||0)+'</span></div>';
    }).join(''))+'</div>'
    +'<div class="card"><div class="card-title">Progresi Mujor</div><canvas id="cana" height="225"></canvas></div></div>'
    +'<div class="g3">'+[['ğŸ‘¥','NxÃ«nÃ«s',students.length],['ğŸ“','Testime',tests.length],['ğŸ“š','Detyra',assignments.length]].map(function(x){return'<div class="card" style="text-align:center"><div style="font-size:26px">'+x[0]+'</div><div style="font-size:26px;font-weight:800;margin-top:6px">'+x[2]+'</div><div style="color:#64748b;font-size:12px;margin-top:2px">'+x[1]+'</div></div>';}).join('')+'</div></div>';
}

// â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function profilePage(){
  return'<div class="fade"><div class="page-hdr"><div class="page-title">ğŸ‘¤ Profili Im</div></div>'
    +'<div style="display:grid;grid-template-columns:240px 1fr;gap:14px">'
    +'<div style="display:flex;flex-direction:column;gap:13px"><div class="card" style="text-align:center;padding:24px 14px">'+AV(CU,68)
    +'<h3 style="font-weight:700;font-size:15px;margin-top:11px">'+CU.name+'</h3><p style="color:#64748b;font-size:12px">'+(CU.role==='teacher'?'MÃ«sues FSHN':'NxÃ«nÃ«s FSHN 2024')+'</p>'
    +(CU.classCode?'<p style="color:#3b82f6;font-size:11px;margin-top:4px">ğŸ”‘ '+CU.classCode+'</p>':'')
    +'<div style="margin-top:10px;padding:7px;border-radius:8px;background:'+(CU.emailVerified?'rgba(16,185,129,.1)':'rgba(245,158,11,.1)')+'"><span style="font-size:11px;color:'+(CU.emailVerified?'#10b981':'#f59e0b')+'">'+(CU.emailVerified?'âœ… Email konfirmuar':'âš ï¸ Email pakonfirmuar')+'</span></div></div>'
    +'<div class="card"><div class="card-title">Statistikat</div>'+[['Email',CU.email],['Roli',CU.role==='teacher'?'MÃ«sues':'NxÃ«nÃ«s'],['PjesÃ«marrja',(CU.attendance||0)+'%'],['Testime',CU.tests||0],['Detyra',CU.assignments||0],['Nota Mes.',CU.avgGrade||'â€”']].map(function(x){return'<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid #334155;font-size:12px"><span style="color:#64748b">'+x[0]+'</span><span style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+x[1]+'</span></div>';}).join('')+'</div></div>'
    +'<div style="display:flex;flex-direction:column;gap:13px"><div class="card"><div class="card-title">Progresi Vjetor</div><canvas id="cprf" height="185"></canvas></div>'
    +'<div class="card"><div class="card-title">ğŸ… Arritjet</div><div class="g3">'+[['âœ…','PjesÃ«marrja',(CU.attendance||0)+'%'],['ğŸ“','Testime',(CU.tests||0)+' kryer'],['ğŸ“š','Detyra',(CU.assignments||0)+' dorÃ«zuar'],['ğŸ“Š','Nota Mes.',CU.avgGrade||'â€”'],['ğŸ””','Njoftimet',notifications.length],['ğŸ†','Statusi',CU.status==='online'?'Online':'Offline']].map(function(x){return'<div style="background:#0f172a;border-radius:10px;padding:10px;text-align:center;border:1px solid rgba(59,130,246,.15)"><div style="font-size:21px;margin-bottom:4px">'+x[0]+'</div><div style="font-size:12px;font-weight:600">'+x[1]+'</div><div style="color:#64748b;font-size:11px;margin-top:2px">'+x[2]+'</div></div>';}).join('')+'</div></div></div></div></div>';
}

// â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var ML=['Tet','NÃ«n','Dhj','Jan','Shk','Mar'],DP=[72,78,75,82,88,91],DT=[65,70,68,75,82,87];
function initCharts(){
  var ll={labels:{color:'#94a3b8',boxWidth:10,font:{family:"'Sora',sans-serif",size:11}}};
  var sc={x:{ticks:{color:'#94a3b8',font:{size:10}},grid:{color:'#1e293b'}},y:{ticks:{color:'#94a3b8',font:{size:10}},grid:{color:'#334155'}}};
  var tt={backgroundColor:'#1e293b',borderColor:'#334155',borderWidth:1,titleColor:'#f8fafc',bodyColor:'#94a3b8'};
  function line(id,key){var c=document.getElementById(id);if(c&&!charts[key])charts[key]=new Chart(c,{type:'line',data:{labels:ML,datasets:[{label:'PjesÃ«marrja',data:DP,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.08)',tension:.4,fill:true,borderWidth:2,pointRadius:3,pointBackgroundColor:'#3b82f6'},{label:'Testime',data:DT,borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.08)',tension:.4,fill:true,borderWidth:2,pointRadius:3,pointBackgroundColor:'#10b981'}]},options:{responsive:true,plugins:{legend:ll,tooltip:tt},scales:sc}});}
  line('cp','cp');line('cana','cana');
  var pie=document.getElementById('cpie');if(pie&&!charts.pie)charts.pie=new Chart(pie,{type:'doughnut',data:{labels:['Prezente','Mungon','Justifikim'],datasets:[{data:[82,12,6],backgroundColor:['#10b981','#ef4444','#f59e0b'],borderWidth:2,borderColor:'#1e293b'}]},options:{responsive:true,plugins:{legend:{display:false},tooltip:tt},cutout:'58%'}});
  var prf=document.getElementById('cprf');if(prf&&!charts.prf)charts.prf=new Chart(prf,{type:'bar',data:{labels:ML,datasets:[{label:'Performanca',data:DT,backgroundColor:'rgba(59,130,246,.5)',borderColor:'#3b82f6',borderWidth:2,borderRadius:6}]},options:{responsive:true,plugins:{legend:ll,tooltip:tt},scales:sc}});
}
} // end startApp
</script>
</body>
</html>
